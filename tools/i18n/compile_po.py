#!/usr/bin/python

def php_str(lines):
    # parse an array of lines like ['"foo"\r\n', '"testing '$bar"\r\n'] and turn it into a valid php string literal
    php_lines = []
    for line in lines:
        line = line.rstrip()
        assert line.startswith('"') and line.endswith('"')
        line = line[1:-1]
        if not line: continue
        line = line.replace(r'\"', '"')
        php_lines.append("'%s'\n" % line.replace("'", r"\'"))

    if not len(php_lines): return "''"
    return ".".join(php_lines)

for language in open("languages.txt").read().split():
    language = language.strip()
    if not language: continue
    
    print "Compiling messages for language: %s" % language

    lines = open("../../web/languages/%s/messages.po" % language).readlines()
    def get():
        line = lines.pop(0)
#        print "got line: %s" % `line`
        return line

    of = open("../../web/languages/%s/strings.php" % language, "wt")
    print>>of, '''<?php

// This file is automatically generated from messages.po.  Do not edit it!

$TRANSLATED_STRINGS = array(
'''

    n_msgs = 0
    while 1:
        if not len(lines): break
        line = get()
        if not line.startswith("msgid"): continue

        # read msgid
        msgid = [line.split(" ", 1)[1]]
        while 1:
            line = get()
            if line.startswith('"'):
                msgid.append(line)
            else:
                break

        # read msgstr
        while not line.startswith("msgstr"):
            line = get()

        msgstr = [line.split(" ", 1)[1]]
        while 1:
            if not len(lines): break
            line = get()
            if line.startswith('"'):
                msgstr.append(line)
            else:
                break

        # write out
        if [x.rstrip() for x in msgid] == ['""']: continue # skip the initial one with all the accounting info
        #print "msgid:",msgid
        #print "msgstr:",msgstr
        print>>of, "%s\n=> %s,\n" % (php_str(msgid).strip(), php_str(msgstr).strip())
        #print "------------------"

        n_msgs += 1

    of.write(''');

?>''')

    print "%d messages compiled" % n_msgs
